<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PersonalJournalDesktopApp.ViewModels"
             xmlns:models="clr-namespace:PersonalJournalDesktopApp.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="PersonalJournalDesktopApp.Views.SearchPage"
             x:DataType="vm:SearchViewModel"
             Title="Search and Filter"
             BackgroundColor="{DynamicResource PrimaryBackground}">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <!-- Search Text -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="10"
                   Padding="0"
                   HasShadow="False">
                <SearchBar Placeholder="Search title or content..."
                           Text="{Binding SearchText}"
                           SearchCommand="{Binding SearchCommand}"
                           TextColor="{DynamicResource PrimaryText}"
                           PlaceholderColor="{DynamicResource SecondaryText}"
                           BackgroundColor="Transparent"/>
            </Frame>

            <!-- Date Range Filter - Collapsible -->
            <toolkit:Expander>
                <toolkit:Expander.Header>
                    <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                           CornerRadius="10"
                           Padding="15"
                           HasShadow="False">
                        <Label Text=" Select Date Range â–¾" 
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource PrimaryText}"/>
                    </Frame>
                </toolkit:Expander.Header>

                <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                       CornerRadius="10"
                       Padding="15"
                       Margin="0,-10,0,0"
                       HasShadow="False">
                    <VerticalStackLayout Spacing="10">
                        <HorizontalStackLayout Spacing="10">
                            <CheckBox IsChecked="{Binding UseStartDate}"
                                      Color="{DynamicResource AccentColor}"/>
                            <Label Text="From:"
                                   VerticalOptions="Center"
                                   TextColor="{DynamicResource PrimaryText}"/>
                            <DatePicker Date="{Binding StartDate}"
                                        Format="MMM dd, yyyy"
                                        TextColor="{DynamicResource PrimaryText}"
                                        IsEnabled="{Binding UseStartDate}"
                                        HorizontalOptions="FillAndExpand"/>
                        </HorizontalStackLayout>

                        <HorizontalStackLayout Spacing="10">
                            <CheckBox IsChecked="{Binding UseEndDate}"
                                      Color="{DynamicResource AccentColor}"/>
                            <Label Text="To:"
                                   VerticalOptions="Center"
                                   TextColor="{DynamicResource PrimaryText}"/>
                            <DatePicker Date="{Binding EndDate}"
                                        Format="MMM dd, yyyy"
                                        TextColor="{DynamicResource PrimaryText}"
                                        IsEnabled="{Binding UseEndDate}"
                                        HorizontalOptions="FillAndExpand"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>
            </toolkit:Expander>

            <!-- Mood Filter - Collapsible -->
            <toolkit:Expander>
                <toolkit:Expander.Header>
                    <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                           CornerRadius="10"
                           Padding="15"
                           HasShadow="False">
                        <Label Text=" Filter by Mood â–¾"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource PrimaryText}"/>
                    </Frame>
                </toolkit:Expander.Header>

                <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                       CornerRadius="10"
                       Padding="15"
                       Margin="0,-10,0,0"
                       HasShadow="False">
                    <FlexLayout BindableLayout.ItemsSource="{Binding AllMoods}"
                                Wrap="Wrap"
                                JustifyContent="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:Mood">
                                <Frame Padding="8,4"
                                       Margin="4"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       BackgroundColor="{DynamicResource SecondaryText}">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=ToggleMoodCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Frame.GestureRecognizers>
                                    <Label TextColor="{DynamicResource PrimaryBackground}"
                                           FontSize="11">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Emoji}"/>
                                                <Span Text=" "/>
                                                <Span Text="{Binding Name}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </Frame>
            </toolkit:Expander>

            <!-- Tag Filter - Collapsible -->
            <toolkit:Expander>
                <toolkit:Expander.Header>
                    <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                           CornerRadius="10"
                           Padding="15"
                           HasShadow="False">
                        <Label Text=" Filter by Tags â–¾"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource PrimaryText}"/>
                    </Frame>
                </toolkit:Expander.Header>

                <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                       CornerRadius="10"
                       Padding="15"
                       Margin="0,-10,0,0"
                       HasShadow="False">
                    <FlexLayout BindableLayout.ItemsSource="{Binding AllTags}"
                                Wrap="Wrap"
                                JustifyContent="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:Tag">
                                <Frame Padding="8,4"
                                       Margin="4"
                                       CornerRadius="12"
                                       HasShadow="False"
                                       BackgroundColor="{DynamicResource SecondaryText}">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=ToggleTagCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Frame.GestureRecognizers>
                                    <Label Text="{Binding Name}"
                                           TextColor="{DynamicResource PrimaryBackground}"
                                           FontSize="11"/>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </Frame>
            </toolkit:Expander>

            <!-- Category Filter - Collapsible -->
            <toolkit:Expander>
                <toolkit:Expander.Header>
                    <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                           CornerRadius="10"
                           Padding="15"
                           HasShadow="False">
                        <Label Text=" Filter by Category â–¾"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource PrimaryText}"/>
                    </Frame>
                </toolkit:Expander.Header>

                <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                       CornerRadius="10"
                       Padding="15"
                       Margin="0,-10,0,0"
                       HasShadow="False">
                    <Picker ItemsSource="{Binding AllCategories}"
                            SelectedItem="{Binding SelectedCategory}"
                            ItemDisplayBinding="{Binding Name}"
                            Title="Select category"
                            FontSize="14"
                            TextColor="{DynamicResource PrimaryText}"
                            BackgroundColor="{DynamicResource PrimaryBackground}"/>
                </Frame>
            </toolkit:Expander>

            <!-- Action Buttons -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                <Button Grid.Column="0"
                        Text="ðŸ” Search"
                        Command="{Binding SearchCommand}"
                        BackgroundColor="{DynamicResource AccentColor}"
                        TextColor="White"
                        FontSize="14"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="45"/>

                <Button Grid.Column="1"
                        Text="Clear Filters"
                        Command="{Binding ClearFiltersCommand}"
                        BackgroundColor="{DynamicResource SecondaryText}"
                        TextColor="White"
                        FontSize="14"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="45"/>
            </Grid>

            <!-- Result Count -->
            <Label Text="{Binding ResultCount, StringFormat='Found {0} entries'}"
                   FontSize="14"
                   FontAttributes="Bold"
                   TextColor="{DynamicResource AccentColor}"
                   HorizontalOptions="Center"/>

            <!-- Divider -->
            <BoxView HeightRequest="1"
                     BackgroundColor="{DynamicResource BorderColor}"
                     Margin="0,10"/>

            <!-- Search Results -->
            <Label Text="Search Results"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="{DynamicResource PrimaryText}"/>

            <VerticalStackLayout Spacing="10"
                                 BindableLayout.ItemsSource="{Binding SearchResults}">
                <BindableLayout.EmptyView>
                    <Label Text="No entries found. Try adjusting your filters or create your first entry!"
                           FontSize="14"
                           TextColor="{DynamicResource SecondaryText}"
                           HorizontalTextAlignment="Center"
                           Margin="0,20"/>
                </BindableLayout.EmptyView>

                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:JournalEntry">
                        <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                               CornerRadius="10"
                               Padding="15"
                               Margin="0,5"
                               HasShadow="True">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer 
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchViewModel}}, Path=ViewEntryCommand}"
                                    CommandParameter="{Binding .}"/>
                            </Frame.GestureRecognizers>

                            <VerticalStackLayout Spacing="8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding Title}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource PrimaryText}"
                                           LineBreakMode="TailTruncation"/>

                                    <Label Grid.Column="1"
                                           Text="{Binding Date, StringFormat='{0:MMM dd}'}"
                                           FontSize="12"
                                           TextColor="{DynamicResource SecondaryText}"
                                           VerticalOptions="Center"
                                           Margin="10,0,0,0"/>
                                </Grid>

                                <Label Text="{Binding Content}"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"/>

                                <HorizontalStackLayout Spacing="5">
                                    <Label Text="{Binding PrimaryMood.Emoji}"
                                           FontSize="16"
                                           IsVisible="{Binding PrimaryMood, Converter={StaticResource IsNotNullConverter}}"/>
                                    <Label Text="{Binding SecondaryMood1.Emoji}"
                                           FontSize="14"
                                           IsVisible="{Binding SecondaryMood1, Converter={StaticResource IsNotNullConverter}}"/>
                                    <Label Text="{Binding SecondaryMood2.Emoji}"
                                           FontSize="14"
                                           IsVisible="{Binding SecondaryMood2, Converter={StaticResource IsNotNullConverter}}"/>
                                </HorizontalStackLayout>

                                <FlexLayout BindableLayout.ItemsSource="{Binding Tags}"
                                            Wrap="Wrap"
                                            JustifyContent="Start">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:Tag">
                                            <Frame BackgroundColor="{DynamicResource AccentColor}"
                                                   Padding="6,3"
                                                   Margin="2"
                                                   CornerRadius="8"
                                                   HasShadow="False">
                                                <Label Text="{Binding Name}"
                                                       TextColor="White"
                                                       FontSize="10"/>
                                            </Frame>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
