<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PersonalJournalDesktopApp.ViewModels"
             xmlns:models="clr-namespace:PersonalJournalDesktopApp.Models"
             x:Class="PersonalJournalDesktopApp.Views.AnalyticsPage"
             x:DataType="vm:AnalyticsViewModel"
             Title="Analytics Dashboard"
             BackgroundColor="{DynamicResource PrimaryBackground}">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Date Filter -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“Š Analytics Period"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <FlexLayout Wrap="Wrap" JustifyContent="Start" AlignItems="Start">
                        <Button Text="Last 30 Days"
                                Command="{Binding SetLast30DaysCommand}"
                                BackgroundColor="{DynamicResource AccentColor}"
                                TextColor="White"
                                FontSize="12"
                                Padding="12,8"
                                Margin="5"
                                CornerRadius="8"/>

                        <Button Text="Last 90 Days"
                                Command="{Binding SetLast90DaysCommand}"
                                BackgroundColor="{DynamicResource AccentColor}"
                                TextColor="White"
                                FontSize="12"
                                Padding="12,8"
                                Margin="5"
                                CornerRadius="8"/>

                        <Button Text="This Year"
                                Command="{Binding SetThisYearCommand}"
                                BackgroundColor="{DynamicResource AccentColor}"
                                TextColor="White"
                                FontSize="12"
                                Padding="12,8"
                                Margin="5"
                                CornerRadius="8"/>

                        <Button Text="Clear Filter"
                                Command="{Binding ClearDateFilterCommand}"
                                BackgroundColor="{DynamicResource SecondaryText}"
                                TextColor="White"
                                FontSize="12"
                                Padding="12,8"
                                Margin="5"
                                CornerRadius="8"/>

                        <Button Text="ðŸ“„ Export PDF"
                                Command="{Binding ExportToPdfCommand}"
                                BackgroundColor="#8b7355"
                                TextColor="White"
                                FontSize="12"
                                Padding="12,8"
                                Margin="5"
                                CornerRadius="8"/>
                    </FlexLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Streak Statistics -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="20"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ”¥ Journaling Streaks"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="15" RowSpacing="15">
                        <!-- Current Streak -->
                        <Frame Grid.Row="0" Grid.Column="0"
                               BackgroundColor="{DynamicResource PrimaryBackground}"
                               Padding="15"
                               CornerRadius="10"
                               HasShadow="False"
                               BorderColor="{DynamicResource BorderColor}">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Current Streak"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding CurrentStreak}"
                                       FontSize="32"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource AccentColor}"
                                       HorizontalOptions="Center"/>
                                <Label Text="days"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Longest Streak -->
                        <Frame Grid.Row="0" Grid.Column="1"
                               BackgroundColor="{DynamicResource PrimaryBackground}"
                               Padding="15"
                               CornerRadius="10"
                               HasShadow="False"
                               BorderColor="{DynamicResource BorderColor}">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Longest Streak"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding LongestStreak}"
                                       FontSize="32"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource AccentColor}"
                                       HorizontalOptions="Center"/>
                                <Label Text="days"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Total Entries -->
                        <Frame Grid.Row="1" Grid.Column="0"
                               BackgroundColor="{DynamicResource PrimaryBackground}"
                               Padding="15"
                               CornerRadius="10"
                               HasShadow="False"
                               BorderColor="{DynamicResource BorderColor}">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Total Entries"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding TotalEntries}"
                                       FontSize="32"
                                       FontAttributes="Bold"
                                       TextColor="{DynamicResource AccentColor}"
                                       HorizontalOptions="Center"/>
                                <Label Text="entries"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Missed Days -->
                        <Frame Grid.Row="1" Grid.Column="1"
                               BackgroundColor="{DynamicResource PrimaryBackground}"
                               Padding="15"
                               CornerRadius="10"
                               HasShadow="False"
                               BorderColor="{DynamicResource BorderColor}">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Missed Days"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding MissedDays}"
                                       FontSize="32"
                                       FontAttributes="Bold"
                                       TextColor="#d32f2f"
                                       HorizontalOptions="Center"/>
                                <Label Text="days"
                                       FontSize="12"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Mood Analytics -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="20"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ˜Š Mood Analytics"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <!-- Most Frequent Mood -->
                    <Frame BackgroundColor="{DynamicResource PrimaryBackground}"
                           Padding="15"
                           CornerRadius="10"
                           HasShadow="False"
                           BorderColor="{DynamicResource BorderColor}">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Most Frequent Mood"
                                   FontSize="12"
                                   TextColor="{DynamicResource SecondaryText}"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding MostFrequentMoodDisplay}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource PrimaryText}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Simple Mood Pie Chart (No External Library) -->
                    <Label Text="Mood Distribution"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"
                           Margin="0,10,0,5"/>

                    <!-- Visual Pie Chart using BoxViews -->
                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" RowSpacing="10" ColumnSpacing="10">
                        <!-- Donut Chart Visualization -->
                        <Grid Grid.Row="0" Grid.ColumnSpan="2" WidthRequest="200" HeightRequest="200" HorizontalOptions="Center">
                            <!-- Background Circle -->
                            <Ellipse Fill="{DynamicResource SecondaryBackground}"
                                     WidthRequest="200"
                                     HeightRequest="200"/>

                            <!-- Segments using Borders and BoxViews for simple representation -->
                            <Grid>
                                <!-- Positive Segment (Top) -->
                                <BoxView Color="#4CAF50"
                                         WidthRequest="{Binding PositivePercentage, Converter={StaticResource PercentageToWidthConverter}}"
                                         HeightRequest="10"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Start"
                                         Margin="0,40,0,0"/>

                                <!-- Neutral Segment (Middle) -->
                                <BoxView Color="#FF9800"
                                         WidthRequest="{Binding NeutralPercentage, Converter={StaticResource PercentageToWidthConverter}}"
                                         HeightRequest="10"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center"/>

                                <!-- Negative Segment (Bottom) -->
                                <BoxView Color="#F44336"
                                         WidthRequest="{Binding NegativePercentage, Converter={StaticResource PercentageToWidthConverter}}"
                                         HeightRequest="10"
                                         HorizontalOptions="Center"
                                         VerticalOptions="End"
                                         Margin="0,0,0,40"/>
                            </Grid>
                        </Grid>

                        <!-- Legend -->
                        <VerticalStackLayout Grid.Row="1" Grid.ColumnSpan="2" Spacing="5" HorizontalOptions="Center">
                            <HorizontalStackLayout Spacing="10">
                                <BoxView Color="#4CAF50" WidthRequest="20" HeightRequest="20" CornerRadius="3"/>
                                <Label Text="{Binding PositivePercentage, StringFormat='Positive: {0:F1}%'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource PrimaryText}"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>

                            <HorizontalStackLayout Spacing="10">
                                <BoxView Color="#FF9800" WidthRequest="20" HeightRequest="20" CornerRadius="3"/>
                                <Label Text="{Binding NeutralPercentage, StringFormat='Neutral: {0:F1}%'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource PrimaryText}"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>

                            <HorizontalStackLayout Spacing="10">
                                <BoxView Color="#F44336" WidthRequest="20" HeightRequest="20" CornerRadius="3"/>
                                <Label Text="{Binding NegativePercentage, StringFormat='Negative: {0:F1}%'}"
                                       FontSize="12"
                                       TextColor="{DynamicResource PrimaryText}"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Traditional Distribution Boxes -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <!-- Positive -->
                        <Frame Grid.Column="0"
                               BackgroundColor="#4CAF50"
                               Padding="10"
                               CornerRadius="10"
                               HasShadow="False">
                            <VerticalStackLayout Spacing="3">
                                <Label Text="Positive"
                                       FontSize="10"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding PositivePercentage, StringFormat='{0:F1}%'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Neutral -->
                        <Frame Grid.Column="1"
                               BackgroundColor="#FF9800"
                               Padding="10"
                               CornerRadius="10"
                               HasShadow="False">
                            <VerticalStackLayout Spacing="3">
                                <Label Text="Neutral"
                                       FontSize="10"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding NeutralPercentage, StringFormat='{0:F1}%'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Negative -->
                        <Frame Grid.Column="2"
                               BackgroundColor="#F44336"
                               Padding="10"
                               CornerRadius="10"
                               HasShadow="False">
                            <VerticalStackLayout Spacing="3">
                                <Label Text="Negative"
                                       FontSize="10"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding NegativePercentage, StringFormat='{0:F1}%'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Word Count Trends -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="20"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“ˆ Word Count Trends (Last 30 Days)"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <!-- Bar Chart -->
                    <ScrollView Orientation="Horizontal" HeightRequest="140">
                        <HorizontalStackLayout Spacing="5"
                                               BindableLayout.ItemsSource="{Binding WordCountTrends}"
                                               Padding="10,0">
                            <BindableLayout.EmptyView>
                                <Label Text="No word count data available yet"
                                       FontSize="14"
                                       TextColor="{DynamicResource SecondaryText}"
                                       HorizontalOptions="Center"
                                       Margin="20"/>
                            </BindableLayout.EmptyView>

                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="vm:WordCountTrendDisplay">
                                    <VerticalStackLayout Spacing="3" WidthRequest="40">
                                        <!-- Word count label -->
                                        <Label Text="{Binding WordCount}"
                                               FontSize="9"
                                               TextColor="{DynamicResource SecondaryText}"
                                               HorizontalOptions="Center"/>

                                        <!-- Bar visualization -->
                                        <BoxView Color="{DynamicResource AccentColor}"
                                                 HeightRequest="{Binding BarHeight}"
                                                 WidthRequest="30"
                                                 CornerRadius="3"
                                                 VerticalOptions="End"/>

                                        <!-- Date label -->
                                        <Label Text="{Binding DateLabel}"
                                               FontSize="9"
                                               TextColor="{DynamicResource SecondaryText}"
                                               HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                    </ScrollView>

                    <!-- Average Word Count -->
                    <Frame BackgroundColor="{DynamicResource PrimaryBackground}"
                           Padding="15"
                           CornerRadius="10"
                           HasShadow="False"
                           BorderColor="{DynamicResource BorderColor}"
                           Margin="0,10,0,0">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Average Word Count"
                                   FontSize="12"
                                   TextColor="{DynamicResource SecondaryText}"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding AverageWordCount, StringFormat='{0:F0}'}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource AccentColor}"
                                   HorizontalOptions="Center"/>
                            <Label Text="words per entry"
                                   FontSize="12"
                                   TextColor="{DynamicResource SecondaryText}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Tag Analytics -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="20"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ·ï¸ Most Used Tags"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding TopTags}" Spacing="8">
                        <BindableLayout.EmptyView>
                            <Label Text="No tag data available yet. Create entries with tags to see analytics!"
                                   FontSize="14"
                                   TextColor="{DynamicResource SecondaryText}"
                                   HorizontalTextAlignment="Center"
                                   Margin="0,10"/>
                        </BindableLayout.EmptyView>

                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:TagStatistic">
                                <Frame BackgroundColor="{DynamicResource PrimaryBackground}"
                                       Padding="12"
                                       Margin="0"
                                       CornerRadius="8"
                                       HasShadow="False"
                                       BorderColor="{DynamicResource BorderColor}">
                                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                                        <Label Grid.Column="0"
                                               Text="{Binding TagName}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{DynamicResource PrimaryText}"
                                               VerticalOptions="Center"/>

                                        <Label Grid.Column="1"
                                               Text="{Binding Count, StringFormat='{0} uses'}"
                                               FontSize="12"
                                               TextColor="{DynamicResource SecondaryText}"
                                               VerticalOptions="Center"/>

                                        <Frame Grid.Column="2"
                                               BackgroundColor="{DynamicResource AccentColor}"
                                               Padding="8,4"
                                               CornerRadius="10"
                                               HasShadow="False">
                                            <Label Text="{Binding Percentage, StringFormat='{0:F1}%'}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="White"/>
                                        </Frame>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
