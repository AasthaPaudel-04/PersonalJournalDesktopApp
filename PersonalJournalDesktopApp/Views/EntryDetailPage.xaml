<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PersonalJournalDesktopApp.ViewModels"
             xmlns:models="clr-namespace:PersonalJournalDesktopApp.Models"
             x:Class="PersonalJournalDesktopApp.Views.EntryDetailPage"
             x:DataType="vm:EntryDetailViewModel"
             Title="{Binding PageTitle}"
             BackgroundColor="{DynamicResource PrimaryBackground}">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- ============== JOURNAL ENTRY: TITLE ============== -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="10"
                   Padding="0"
                   HasShadow="False">
                <Entry Placeholder="Entry Title *"
                       Text="{Binding Title}"
                       FontSize="18"
                       TextColor="{DynamicResource PrimaryText}"
                       PlaceholderColor="{DynamicResource SecondaryText}"
                       BackgroundColor="Transparent"
                       Margin="10"/>
            </Frame>

            <!-- ============== JOURNAL ENTRY: RICH TEXT CONTENT ============== -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="10"
                   Padding="0"
                   HasShadow="False">
                <WebView x:Name="EditorWebView"
                         HeightRequest="400"
                         HorizontalOptions="FillAndExpand"
                         VerticalOptions="FillAndExpand"/>
            </Frame>

            <!-- ============== CATEGORY SELECTION ============== -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“ Category (Optional)"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <Picker ItemsSource="{Binding AllCategories}"
                            SelectedItem="{Binding SelectedCategory}"
                            ItemDisplayBinding="{Binding Name}"
                            Title="Select category"
                            FontSize="14"
                            TextColor="{DynamicResource PrimaryText}"
                            BackgroundColor="{DynamicResource PrimaryBackground}"/>
                </VerticalStackLayout>
            </Frame>

            <!-- ============== MOOD TRACKING SECTION ============== -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="How are you feeling?"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <!-- MOOD TRACKING: Primary Mood (Required) -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Primary Mood *"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource SecondaryText}"/>

                        <Picker ItemsSource="{Binding AllMoods}"
                                SelectedItem="{Binding SelectedPrimaryMood}"
                                ItemDisplayBinding="{Binding Name}"
                                Title="Select primary mood"
                                FontSize="16"
                                TextColor="{DynamicResource PrimaryText}"
                                BackgroundColor="{DynamicResource PrimaryBackground}"/>

                        <Label Text="{Binding SelectedPrimaryMood.Emoji}"
                               FontSize="40"
                               HorizontalOptions="Center"
                               IsVisible="{Binding SelectedPrimaryMood, Converter={StaticResource IsNotNullConverter}}"/>
                    </VerticalStackLayout>

                    <!-- MOOD TRACKING: Secondary Mood 1 (Optional) -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Secondary Mood 1 (Optional)"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource SecondaryText}"/>

                        <Picker ItemsSource="{Binding AllMoods}"
                                SelectedItem="{Binding SelectedSecondaryMood1}"
                                ItemDisplayBinding="{Binding Name}"
                                Title="Select secondary mood"
                                FontSize="16"
                                TextColor="{DynamicResource PrimaryText}"
                                BackgroundColor="{DynamicResource PrimaryBackground}"/>

                        <Label Text="{Binding SelectedSecondaryMood1.Emoji}"
                               FontSize="30"
                               HorizontalOptions="Center"
                               IsVisible="{Binding SelectedSecondaryMood1, Converter={StaticResource IsNotNullConverter}}"/>
                    </VerticalStackLayout>

                    <!-- MOOD TRACKING: Secondary Mood 2 (Optional) -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Secondary Mood 2 (Optional)"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource SecondaryText}"/>

                        <Picker ItemsSource="{Binding AllMoods}"
                                SelectedItem="{Binding SelectedSecondaryMood2}"
                                ItemDisplayBinding="{Binding Name}"
                                Title="Select secondary mood"
                                FontSize="16"
                                TextColor="{DynamicResource PrimaryText}"
                                BackgroundColor="{DynamicResource PrimaryBackground}"/>

                        <Label Text="{Binding SelectedSecondaryMood2.Emoji}"
                               FontSize="30"
                               HorizontalOptions="Center"
                               IsVisible="{Binding SelectedSecondaryMood2, Converter={StaticResource IsNotNullConverter}}"/>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- ============== TAGS SECTION ============== -->
            <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                   CornerRadius="15"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <Label Text="ðŸ·ï¸ Tags"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource PrimaryText}"/>

                    <!-- Add New Tag -->
                    <HorizontalStackLayout Spacing="10">
                        <Entry Placeholder="Add custom tag..."
                               Text="{Binding NewTagName}"
                               FontSize="14"
                               HorizontalOptions="FillAndExpand"
                               TextColor="{DynamicResource PrimaryText}"
                               PlaceholderColor="{DynamicResource SecondaryText}"
                               BackgroundColor="{DynamicResource PrimaryBackground}"/>

                        <Button Text="+"
                                Command="{Binding AddNewTagCommand}"
                                BackgroundColor="{DynamicResource AccentColor}"
                                TextColor="{DynamicResource PrimaryBackground}"
                                FontSize="18"
                                FontAttributes="Bold"
                                WidthRequest="40"
                                HeightRequest="40"
                                CornerRadius="20"/>
                    </HorizontalStackLayout>

                    <!-- Selected Tags -->
                    <Label Text="Selected Tags:"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource SecondaryText}"
                           IsVisible="{Binding SelectedTags.Count}"/>

                    <FlexLayout BindableLayout.ItemsSource="{Binding SelectedTags}"
                                Wrap="Wrap"
                                JustifyContent="Start"
                                AlignItems="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:Tag">
                                <Frame BackgroundColor="{DynamicResource AccentColor}"
                                       Padding="8,4"
                                       Margin="4"
                                       CornerRadius="12"
                                       HasShadow="False">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EntryDetailViewModel}}, Path=ToggleTagCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Frame.GestureRecognizers>
                                    <Label Text="{Binding Name}"
                                           TextColor="{DynamicResource PrimaryBackground}"
                                           FontSize="12"/>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>

                    <!-- Available Tags -->
                    <Label Text="Tap tags to add/remove:"
                           FontSize="14"
                           TextColor="{DynamicResource SecondaryText}"
                           Margin="0,10,0,5"/>

                    <ScrollView Orientation="Horizontal" HeightRequest="100">
                        <FlexLayout BindableLayout.ItemsSource="{Binding AllTags}"
                                    Wrap="Wrap"
                                    Direction="Row"
                                    JustifyContent="Start"
                                    AlignItems="Start">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Tag">
                                    <Frame Padding="8,4"
                                           Margin="4"
                                           CornerRadius="12"
                                           HasShadow="False">
                                        <Frame.Style>
                                            <Style TargetType="Frame">
                                                <Setter Property="BackgroundColor" Value="{DynamicResource SecondaryText}"/>
                                            </Style>
                                        </Frame.Style>
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EntryDetailViewModel}}, Path=ToggleTagCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Frame.GestureRecognizers>
                                        <Label Text="{Binding Name}"
                                               TextColor="{DynamicResource PrimaryBackground}"
                                               FontSize="11"/>
                                    </Frame>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </ScrollView>
                </VerticalStackLayout>
            </Frame>

            <!-- ============== ACTION BUTTONS ============== -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <Button Grid.Column="0"
                        Text="Save"
                        Command="{Binding SaveEntryCommand}"
                        BackgroundColor="{DynamicResource AccentColor}"
                        TextColor="{DynamicResource PrimaryBackground}"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="50"/>

                <Button Grid.Column="1"
                        Text="Cancel"
                        Command="{Binding CancelCommand}"
                        BackgroundColor="{DynamicResource SecondaryText}"
                        TextColor="{DynamicResource PrimaryBackground}"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="50"/>
            </Grid>

            <!-- Delete Button (only for existing entries) -->
            <Button Text="ðŸ—‘ï¸ Delete Entry"
                    Command="{Binding DeleteEntryCommand}"
                    IsVisible="{Binding IsNewEntry, Converter={StaticResource InvertedBoolConverter}}"
                    BackgroundColor="Transparent"
                    TextColor="#d32f2f"
                    FontSize="14"
                    BorderColor="#d32f2f"
                    BorderWidth="1"
                    CornerRadius="10"
                    HeightRequest="45"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
